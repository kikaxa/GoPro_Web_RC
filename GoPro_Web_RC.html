<!DOCTYPE html>
<html lang="en">

<!--
    Version: 1.4.0-kix
-->

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>GoPro BLE RC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* #1c1c1c dark gray; #4d4d4d gray; #005eab blue; #009fe0 light blue; #fff wihte */
        html {
            font-family: Segoe UI, Frutiger, Frutiger Linotype, Dejavu Sans, Helvetica Neue, Arial, sans-serif;
            display: inline-block;
            text-align: center;
            background-color: #1c1c1c;
            color: #fff;
        }

        input {
            background-color: #009fe0;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 2px;
            font-weight: bold;
        }

        .list-btn {
            margin: 0;
        }

        input:hover {
            background-color: #005eab;
            transition: .3s;
        }

        legend {
            margin: 0;
        }

        fieldset {
            display: flex;
            border-radius: 5px;
            justify-content: space-around;
            margin: 0 0 10px 0;
        }

        .h2 {
            font-size: 1.9rem;
            margin-top: 10px;
        }

        p {
            font-size: 1.0rem;
        }

        body {
            max-width: 600px;
            margin: 0px auto;
        }

        fieldset.foldable {
            height: 0px;
            overflow: hidden;
        }

        fieldset.foldable.expanded {
            height: auto;
        }

        fieldset.foldable>legend::after {
            content: "+";
            margin: 0px 5px 0px 15px;
            padding: 0px 8px 5px 8px;
            background-color: #009fe0;
            border-radius: 5px;
            cursor: default;
            display: inline-block;
            width: 11px;
            text-align: center;
        }

        fieldset.foldable.expanded>legend::after {
            content: "-";
            margin: 0px 5px 0px 15px;
            padding: 0px 8px 5px 8px;
            background-color: #009fe0;
            border-radius: 5px;
            cursor: default;
            display: inline-block;
            width: 11px;
            text-align: center;
        }

        .styled-table {
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9em;
            width: 100%;
        }

        .styled-table td {
            padding: 5px 0;
        }

        .styled-table th {
            padding: 0px 5px;
        }

        .styled-table .cam-th {
            border-right: 1px solid #fff;
        }

        .styled-table .cam-td {
            border-right: 1px solid #fff;
            text-align: left;
        }

        .styled-table .cam-td span {
            margin: 0px 5px;
            white-space: nowrap;
        }

        .styled-table .cam-td div {
            padding: 2px;
        }

        .styled-table thead tr {
            background-color: #005eab;
            color: #ffffff;
        }

        .styled-table tbody tr {
            border-bottom: 1px solid #dddddd;
            background-color: #4d4d4d;
        }

        .styled-table tbody tr:nth-of-type(even) {
            background-color: #1c1c1c;
        }

        .styled-table tbody tr:last-of-type {
            border-bottom: 2px solid #005eab;
        }

        .menu {
            width: fit-content;
            padding: 6px 4px 2px 4px;
            background-color: #1c1c1c;
            transition: .3s;
            position: absolute;
            list-style: none;
            border-radius: 5px;
        }

        .menu-title {
            margin: -6px -4px 15px -4px;
            border-bottom: 2px solid white;
            padding: 6px;
            border-radius: 5px;
            background-color: #004073;
            font-size: 10pt;
            color: white;
            border-top: 2px solid white;
        }

        .has-submenu::after {
            content: "\25BC";
            float: right;
            margin-left: 5px;
        }

        .item {
            border-top: 2px solid #fff;
            border-bottom: 2px solid #fff;
            border-radius: 4px;
            background: #4d4d4d;
            overflow: hidden;
            list-style: none;
            padding: 5px;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .item:hover {
            background: #009fe0;
            transition: .3s;
        }

        .menu .submenu {
            display: none;
            position: absolute;
            background-color: #1c1c1c;
            padding: 0px;
            color: white;
            border-radius: 5px;
            left: -20px;
            margin-top: 7px;
        }

        .menu .has-submenu:hover .submenu,
        .menu .has-submenu:active .submenu,
        .menu .has-submenu:focus .submenu {
            display: block;
        }

        .has-submenu:hover::after,
        .has-submenu:active::after,
        .has-submenu:focus::after {
            content: "\25B2";
        }
    </style>
</head>

<body>
    <div style="display: flex; justify-content: space-between;">
        <b class="h2">GoPro Web RC</b>
        <input type="button" onclick="onClickPair();" value="Connect/Pair new"
            style="height: fit-content;margin-top: 15px;">
    </div>
    <span id="status" style="display: block;min-height: 22px;color:#ffbf00;"></span>
    <fieldset>
        <legend style="text-align: left;"><b>Control</b></legend>
        <div style="display:inline-block;">
            <input type="button" onclick="sendCommand(shutterOn);" value="Shutter: on">
            <input type="button" onclick="sendCommand(shutterOff);" value="Shutter: off"><br>
            <input type="button" onclick="sendCommand(camSleep);" value="Put camera to sleep">
            <input type="button" onclick="sendCommand(wiFiAPoff);" value="WiFi AP: off">
            <input type="button" onclick="sendCommand(wiFiAPon);" value="WiFi AP: on">
            <input type="button" onclick="sendCommand(hilight);" value="Hilight moment">
        </div>
    </fieldset>
    <fieldset class="foldable expanded">
        <legend style="text-align: left;" onclick="this.parentNode.classList.toggle('expanded');"><b>Load Presets</b>
        </legend>
        <div style="display:inline-block;">
            <input type="button" onclick="sendCommand(videoGroup);" value="Video Group" style="margin-top: 10px;">
            <input type="button" onclick="sendCommand(photoGroup);" value="Photo Group">
            <input type="button" onclick="sendCommand(timelapseGroup);" value="Timelapse Group"><br>
            <input type="button" onclick="sendCommand(standard);" value="Standard">
            <input type="button" onclick="sendCommand(activity);" value="Activity">
            <input type="button" onclick="sendCommand(cinematic);" value="Cinematic">
            <input type="button" onclick="sendCommand(photo);" value="Photo">
            <input type="button" onclick="sendCommand(liveBurst);" value="Live Burst">
            <input type="button" onclick="sendCommand(burstPhoto);" value="Burst Photo">
            <input type="button" onclick="sendCommand(nightPhoto);" value="Night Photo">
            <input type="button" onclick="sendCommand(timeWarp);" value="Time Warp">
            <input type="button" onclick="sendCommand(timeLapse);" value="Time Lapse">
            <input type="button" onclick="sendCommand(nightLapse);" value="Night Lapse">
        </div>
    </fieldset>
    <fieldset class="foldable expanded">
        <legend style="text-align: left;" onclick="this.parentNode.classList.toggle('expanded');toggleCamMenu();">
            <b>Connected devices</b>
        </legend>
        <table id="dev_list" class="styled-table">
            <thead>
                <tr>
                    <th class="cam-th">Cam</th>
                    <th style="width: 86px;">Menu</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </fieldset>
    <fieldset id="errorLog" class="foldable">
        <legend style="text-align: left;" onclick="this.parentNode.classList.toggle('expanded');"><b>Error Log</b>
        </legend>
        <table id="error_log_table" class="styled-table">
            <thead>
                <tr>
                    <th class="cam-th" style="width: 140px;">Timestamp</th>
                    <th style="text-align: left;padding-left: 10px;">Message</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </fieldset>

    <ul id="menu-box" class="menu" style="display: none;">
        <li class="menu-title has-submenu">Single Control
            <ul class="submenu">
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [shutterOn, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Shutter: on</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [shutterOff, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Shutter: off</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [camSleep, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Put camera to sleep</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [wiFiAPoff, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    WiFi AP: off</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [wiFiAPon, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    WiFi AP: on</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [locateOff, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Locate: off</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [locateOn, this.parentNode.parentNode.parentNode.dataset.camindex]);">
                    Locate: on</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [hilight, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Hilight moment</li>
            </ul>
        </li>

        <li class="menu-title has-submenu">Single Load Preset
            <ul class="submenu">
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [videoGroup, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Video Group</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [photoGroup, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Photo Group</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [timelapseGroup, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Timelapse Group</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [standard, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Standard</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [activity, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Activity</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [cinematic, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Cinematic</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [photo, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Photo</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [liveBurst, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Live Burst</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [burstPhoto, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Burst Photo</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [nightPhoto, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Night Photo</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [timeWarp, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Time Warp</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [timeLapse, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Time Lapse</li>
                <li class="item"
                    onclick="bufferBtAction(sendCommandToSingle, [nightLapse, this.parentNode.parentNode.parentNode.dataset.camindex]); toggleCamMenu();">
                    Night Lapse</li>

            </ul>
        </li>

        <li class="menu-title has-submenu">Single Settings
            <ul class="submenu">
                <li class="item"
                    onclick="setDateTime(this.parentNode.parentNode.parentNode.dataset.camindex); toggleCamMenu();">
                    Set Date/Time</li>
            </ul>
        </li>
    </ul>
</body>

<script>
    // Custom GoPro services
    var controlServiceUUID = "0000fea6-0000-1000-8000-00805f9b34fb"; // Cam control service
    // Standard services
    var defInfoUUID = "0000180a-0000-1000-8000-00805f9b34fb";  // Device information
    var battInfoUUID = "0000180f-0000-1000-8000-00805f9b34fb"; // Battery service
    // Custom GoPro characteristics
    var networkUUID = "b5f90091-aa8d-11e3-9046-0002a5d5c51b";       // Command [WRITE]
    var commandUUID = "b5f90072-aa8d-11e3-9046-0002a5d5c51b";       // Command [WRITE]
    var commandRespUUID = "b5f90073-aa8d-11e3-9046-0002a5d5c51b";   // Command response [NOTIFY]
    var settingsUUID = "b5f90074-aa8d-11e3-9046-0002a5d5c51b";      // Settings [WRITE]
    var settingsRespUUID = "b5f90075-aa8d-11e3-9046-0002a5d5c51b";  // Settings response [NOTIFY]
    var queryUUID = "b5f90076-aa8d-11e3-9046-0002a5d5c51b";      // Query [WRITE]
    var queryRespUUID = "b5f90077-aa8d-11e3-9046-0002a5d5c51b";  // Query response [NOTIFY]
    // Standard characteristics
    var modelNoUUID = "00002a24-0000-1000-8000-00805f9b34fb";  // Model number
    var battLevelUUID = "00002a19-0000-1000-8000-00805f9b34fb"; // Battery level [READ | NOTIFY] -> "100% battery level"

    /*
    * BT-Commands
    */
    // Settings (0x0074)
    var keepAlive = Uint8Array.from([0x03, 0x5B, 0x01, 0x42]); // Only Hero 9 and 10 ? Hero 8 response is Error
    // Commands (0x0072)
    var shutterOff = Uint8Array.from([0x03, 0x01, 0x01, 0x00]);
    var shutterOn = Uint8Array.from([0x03, 0x01, 0x01, 0x01]);
    var camSleep = Uint8Array.from([0x01, 0x05]);
    var locateOff = Uint8Array.from([0x03, 0x16, 0x01, 0x00]);
    var locateOn = Uint8Array.from([0x03, 0x16, 0x01, 0x01]);
    var wiFiAPoff = Uint8Array.from([0x03, 0x17, 0x01, 0x00]);
    var wiFiAPon = Uint8Array.from([0x03, 0x17, 0x01, 0x01]);
    var hilight = Uint8Array.from([0x01, 0x18]);
    var videoGroup = Uint8Array.from([0x04, 0x3E, 0x02, 0x03, 0xE8]);
    var photoGroup = Uint8Array.from([0x04, 0x3E, 0x02, 0x03, 0xE9]);
    var timelapseGroup = Uint8Array.from([0x04, 0x3E, 0x02, 0x03, 0xEA]);
    var standard = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x00, 0x00, 0x00]);
    var activity = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x00, 0x00, 0x01]);
    var cinematic = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x00, 0x00, 0x02]);
    var photo = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x00]);
    var liveBurst = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x01]);
    var burstPhoto = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x02]);
    var nightPhoto = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x03]);
    var timeWarp = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x02, 0x00, 0x00]);
    var timeLapse = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x02, 0x00, 0x01]);
    var nightLapse = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x02, 0x00, 0x02]);
    // Querys (0x0076)
    var qSpace = Uint8Array.from([0x02, 0x13, 0x36]);
    var qPreset = Uint8Array.from([0x02, 0x13, 0x61]);

    // TODO get all GoPro model IDs
    var gopro_models = {
        62: "Hero 12",
        60: "Hero 11 Black Mini",
        58: "Hero 11 Black",
        57: "Hero 10 Black",
        55: "Hero 9 Black",
        51: "GoPro Max",
        50: "Hero 8 Black",
        30: "Hero 7 Black",
        24: "Hero 6 Black",
        21: "Hero 5 Session",
        19: "Hero 5 Black",
    }
    var presets = {
        0x00000000: "Standard",
        0x00000001: "Activity",
        0x00000002: "Cinematic",
        0x00000003: "Slo-Mo",
        0x00000004: "Ultra Slo-Mo",
        0x00000005: "Basic",
        0x00010000: "Photo",
        0x00010001: "Live Burst",
        0x00010002: "Burst Photo",
        0x00010003: "Night Photo",
        0x00020000: "Time Warp",
        0x00020001: "Time Lapse",
        0x00020002: "Night Lapse",
        0x00030000: "Max Video",
        0x00040000: "Max Photo",
        0x00050000: "Max Timewarp",
    }
    var connectingDev = null;
    var connectedDevs = [];
    var dev_list_body = document.getElementById("dev_list").tBodies[0];
    var btActionBuffer = [];
    var execMillis = 0;

    window.addEventListener("DOMContentLoaded", function () {
        showInfo("Click on 'Connect/Pair new'", 0);
        execMillis = new Date();
        bufferExecNext(); //starts the buffered execution of BT actions
        window.setInterval(intervalActions, 250);
        logError("Program started")
    });

    /*
    *   Pairing / Connecting
    */
    function onClickPair() {
        if (connectingDev != null) {
            showInfo("A connect process with '" + connectingDev.name + "' is already in progress!", 3000);
            return;
        }
        let filters = [];
        let options = {};

        filters.push({ services: [controlServiceUUID] });
        options.filters = filters;
        options.optionalServices = [controlServiceUUID, defInfoUUID, battInfoUUID];

        console.log('Requesting Bluetooth Device...');
        console.log('with ' + JSON.stringify(options));

        navigator.bluetooth.requestDevice(options)
            .then(device => {
                if (device.name === null) {
                    showInfo("Device name is 'null'! Is the camera paired with your device via Bluetooth?", 6000);
                    logError("[navigator.bluetooth.requestDevice] Device name is 'null'");
                    resetConnectingDev();
                    return;
                }
                console.log("Connecting to '" + device.name + "'.");
                showInfo("Connecting to '" + device.name + "'. Make sure the camera is powered on and wait...", 0);

                // Check if device is always conencted
                for (var i = 0; i < connectedDevs.length; i++) {
                    if (connectedDevs[i].server.device.id == device.id && connectedDevs[i].server.connected) {
                        showInfo("'" + device.name + "' is always connected!", 3000);
                        return; // device is always connected
                    }
                }

                // Timeout 60s for connect()
                connectingDev = device;
                window.setTimeout(function () {
                    if (connectingDev != null) {
                        showInfo("Connecting '" + connectingDev.name + "' timeout! Please retry!", 5000);
                        resetConnectingDev();
                    }
                }, 60000);
                return device.gatt.connect();
            })
            .then(server => {
                if (server == null) {
                    logError("[gatt.connect] Server is 'null'");
                    return;
                }
                connectingDev = null;
                console.log('GATT connected');

                var goProDevice = {};
                goProDevice.server = server;
                goProDevice.Name = server.device.name;
                goProDevice.Model = "?";
                goProDevice.ModelID = 0;
                goProDevice.Preset = "N/A";
                goProDevice.Battery = "?";
                goProDevice.Memory = "?";
                goProDevice.LE = "None"; // last error
                goProDevice.lastKeepAlive = new Date();
                goProDevice.lastPresetQuery = new Date();
                goProDevice.lastMemoryQuery = new Date();
                goProDevice.lastBatteryRead = new Date();
                goProDevice.server.device.addEventListener('gattserverdisconnected', onDisconnected);

                // Save connected cam in array
                connectedDevs.push(goProDevice);
                showInfo("Cam '" + goProDevice.Name + "' connected!", 3000);
                console.log('Getting Services...');
                return server.getPrimaryServices();
            })
            .then(service => {
                if (service == null) {
                    logError("[getPrimaryServices] Service is 'null'");
                    return;
                }

                for (var d = 0; d < connectedDevs.length; d++) {
                    if (connectedDevs[d].server.device.id == service[0].device.id) {
                        connectedDevs[d].services = service;
                        var dev = connectedDevs[d];

                        for (var i = 0; i < dev.services.length; i++) {
                            var service = dev.services[i];

                            switch (service.uuid) {
                                case controlServiceUUID:
                                    console.log('Got control Service');
                                    console.log('Getting control Characteristics...');
                                    bufferBtAction(getCharacteristic, [service, commandUUID]);
                                    bufferBtAction(getCharacteristic, [service, commandRespUUID]);
                                    bufferBtAction(getCharacteristic, [service, settingsUUID]);
                                    bufferBtAction(getCharacteristic, [service, settingsRespUUID]);
                                    bufferBtAction(getCharacteristic, [service, queryUUID]);
                                    bufferBtAction(getCharacteristic, [service, queryRespUUID]);
                                    break;
                                case defInfoUUID:
                                    console.log('Got defInfo Service');
                                    console.log('Getting model_number_string Characteristic...');
                                    bufferBtAction(getCharacteristic, [service, modelNoUUID]);
                                    break;
                                case battInfoUUID:
                                    console.log('Got battInfo Service');
                                    console.log('Getting battLevel Characteristic...');
                                    bufferBtAction(getCharacteristic, [service, battLevelUUID]);
                                    break;
                            }
                        }
                        break;
                    }
                }
            })
            .catch(error => {
                showInfo("[onClickPair] " + error, 0);
                logError("[onClickPair] " + error);
                resetConnectingDev();
            });
    }

    function getCharacteristic(args) {
        var service = args[0],
            uuid = args[1];

        service.getCharacteristic(uuid)
            .then(characteristic => {
                bufferExecNext();
                if (characteristic == null) {
                    logError("[getCharacteristic] Characteristic is 'null'");
                    return;
                }
                console.log('Got Characteristic');

                // Save characteristic in connectedDevs[i]
                for (var i = 0; i < connectedDevs.length; i++) {
                    if (connectedDevs[i].server.device.id == characteristic.service.device.id) {
                        var dev = connectedDevs[i];

                        switch (characteristic.uuid) {
                            case commandUUID:
                                dev.commandCharacteristic = characteristic;
                                return;
                            case commandRespUUID:
                                dev.commandRespCharacteristic = characteristic;
                                startNotifications(dev.commandRespCharacteristic);
                                return;
                            case settingsUUID:
                                dev.settingsCharacteristic = characteristic;
                                return;
                            case settingsRespUUID:
                                dev.settingsRespCharacteristic = characteristic;
                                startNotifications(dev.settingsRespCharacteristic);
                                return;
                            case queryUUID:
                                dev.queryCharacteristic = characteristic;
                                return;
                            case queryRespUUID:
                                dev.queryRespCharacteristic = characteristic;
                                startNotifications(dev.queryRespCharacteristic);
                                return;
                            case modelNoUUID:
                                dev.modelNoCharacteristic = characteristic;
                                bufferBtAction(readValue, [dev.modelNoCharacteristic]);
                                return;
                            case battLevelUUID:
                                dev.battLevelCharacteristic = characteristic;
                                bufferBtAction(readValue, [dev.battLevelCharacteristic]);
                                return;
                        }
                    }
                }
            })
            .catch(error => {
                bufferExecNext();
                console.log(new Date().toLocaleString() + ' [getCharacteristic] ERROR! ' + error);
                logError("[getCharacteristic] " + error);
                if (connectingDev != null) {
                    showInfo("Connecting '" + connectingDev.name + "' error: '" + error + "'. Please retry!", 5000);
                    resetConnectingDev();
                }
            });
    }

    function startNotifications(characteristic) {
        characteristic.startNotifications()
            .then(_ => {
                console.log('> Characteristic Notifications started');
                characteristic.addEventListener('characteristicvaluechanged', handleRespNotifications);
            })
            .catch(error => {
                if (error.message.includes("Authentication failed")) {
                    removeConnectedDev(characteristic.service.device);
                    resetConnectingDev();

                    showInfo("Authentication failed! Perform Bluetooth pairing first! See Error Log for details!");
                    logError("[startNotifications] " + error);
                    logError("Authentication failed!<br>Please first perform a Bluetooth pairing with the camera via your device Bluetooth manager!");
                    document.getElementById("errorLog").classList.add('expanded');
                }
            });
    }

    function removeConnectedDev(dev) {
        if (dev === null)
            return;

        for (var i = 0; i < connectedDevs.length; i++) {
            if (connectedDevs[i].server.device.id == dev.gatt.device.id) {
                connectedDevs[i].server.device.removeEventListener('gattserverdisconnected', onDisconnected);
                connectedDevs[i].server.device.gatt.disconnect();
                connectedDevs.splice(i, 1);
                dev = null;
                updateList();
                break;
            }
        }
    }

    function resetConnectingDev() {
        if (connectingDev === null)
            return;

        connectingDev.gatt.disconnect();
        updateList();
        connectingDev = null;
    }

    /*
    *   Non-blocking asynchronous execution of the BLE communication functions
    */
    function bufferBtAction(action, ...args) {
        btActionBuffer.push([action, args]);
    }

    function bufferExecNext() {
        var lastExecMillis = new Date() - execMillis;
        console.log(new Date().toLocaleString() + ' [bufferExecNext] Last execution millis = ' + lastExecMillis);
        (function chunk() {
            if (btActionBuffer.length < 1) {
                setTimeout(chunk, 0);
            } else {
                if (btActionBuffer.length >= 10)
                    logError("[bufferExecNext] There is too much in the btActionBuffer! (" + btActionBuffer.length + ")");
                execMillis = new Date();
                var btAction = btActionBuffer.pop();
                btAction[0](...btAction[1]); //TODO! Hardcoded number of arguments! How can this be done better?
            }
        })();
    }

    /*
    *   Active BLE communication
    */
    function readValue(args) { //maximum execution time measured is 122 ms
        var characteristic = args[0];

        if (characteristic == null) {
            logError("[readValue] Characteristic is 'null'");
            bufferExecNext();
            return;
        }
        console.log(new Date().toLocaleString() + ' [readValue] ' + characteristic.uuid);
        characteristic.readValue()
            .then(value => {
                bufferExecNext();
                for (var i = 0; i < connectedDevs.length; i++) {
                    if (connectedDevs[i].server.device.id == characteristic.service.device.id) {
                        let decoder = new TextDecoder('utf-8');

                        switch (characteristic.uuid) {
                            case modelNoUUID:
                                let value_str = decoder.decode(value);
                                connectedDevs[i].ModelID = parseInt("0x" + value_str);

                                var model_name = gopro_models[connectedDevs[i].ModelID];
                                if (model_name != null)
                                    connectedDevs[i].Model = model_name;
                                else {
                                    connectedDevs[i].Model = connectedDevs[i].ModelID;
                                    alert("Your GoPro model is unknown.\nPlease tell the autor your camera model and the model ID: " + connectedDevs[i].ModelID);
                                }

                                console.log('> Model is ' + connectedDevs[i].Model);
                                updateList();
                                return;
                            case battLevelUUID:
                                connectedDevs[i].Battery = value.getUint8(0);

                                updateList();
                                return;
                        }
                    }
                }
            })
            .catch(error => {
                console.log(new Date().toLocaleString() + ' [readValue] ERROR! ' + error);
                logError("[readValue] " + error);
                bufferExecNext();
            });
    }

    function sendCommand(command) {
        for (var i = 0; i < connectedDevs.length; i++) {
            bufferBtAction(sendCommandToSingle, [command, i]);
        }
    }

    function sendCommandToSingle(args) {
        var command = args[0],
            camIndex = args[1];

        var headerLength = getHeaderLength(command);

        if (connectedDevs[camIndex].server != null)
            if (connectedDevs[camIndex].server.connected) {
                connectedDevs[camIndex].commandCharacteristic.writeValueWithoutResponse(command)
                    .then(_ => {
                        bufferExecNext();
                    })
                    .catch(error => {
                        console.log(new Date().toLocaleString() + ' [sendCommandToSingle] ERROR! ' + error);
                        logError("[sendCommandToSingle] " + error);
                        bufferExecNext();
                    });
            }
    }

    function sendSettingToSingle(args) {
        var setting = args[0],
            camIndex = args[1];

        var headerLength = getHeaderLength(setting);

        if (connectedDevs[camIndex].server != null)
            if (connectedDevs[camIndex].server.connected) {
                console.log(new Date().toLocaleString() + ' [sendSettingToSingle] ' + setting);
                connectedDevs[camIndex].settingsCharacteristic.writeValueWithoutResponse(setting)
                    .then(_ => {
                        bufferExecNext();
                    })
                    .catch(error => {
                        console.log(new Date().toLocaleString() + ' [sendSettingToSingle] ERROR! ' + error);
                        logError("[sendSettingToSingle] " + error);
                        bufferExecNext();
                    });
            }
    }

    function sendQueryToSingle(args) {
        var query = args[0],
            camIndex = args[1];

        var headerLength = getHeaderLength(query);

        if (connectedDevs[camIndex].server != null)
            if (connectedDevs[camIndex].server.connected) {
                console.log(new Date().toLocaleString() + ' [sendQueryToSingle] ' + query);
                connectedDevs[camIndex].queryCharacteristic.writeValueWithoutResponse(query)
                    .then(_ => {
                        bufferExecNext();
                    })
                    .catch(error => {
                        console.log(new Date().toLocaleString() + ' [sendQueryToSingle] ERROR! ' + error);
                        logError("[sendQueryToSingle] " + error);
                        bufferExecNext();
                    });
            }
    }

    function setDateTime(camIndex) {
        var now = new Date();
        let yyH = now.getFullYear() & 0xFF;
        let yyL = (now.getFullYear() >> 8) & 0xFF;
        // Set date/time to 2022-01-02 03:04:05 	Command: 09: 0D: 07: 07:E6: 01: 02: 03: 04: 05
        var command = Uint8Array.from([0x09, 0x0d, 0x07, yyL, yyH, (now.getMonth() + 1), now.getDate(), now.getHours(), now.getMinutes(), now.getSeconds()]);
        bufferBtAction(sendCommandToSingle, [command, camIndex]);
    }

    function intervalActions() {
        if (connectingDev == null)
            for (var i = 0; i < connectedDevs.length; i++) {
                var now = new Date();

                // Send "keep alive" every 60 seconds; only for models newer then hero 8
                if (now - connectedDevs[i].lastKeepAlive > 60000) {
                    if (connectedDevs[i].ModelID > 50) {
                        bufferBtAction(sendSettingToSingle, [i, keepAlive]);
                        connectedDevs[i].lastKeepAlive = now;
                    } else {
                        // TODO other way to keep alive for hero 8 and downwards?
                    }
                }

                // Query "Remaining space"
                if (now - connectedDevs[i].lastMemoryQuery > 7000) {
                    bufferBtAction(sendQueryToSingle, [qSpace, i]);
                    connectedDevs[i].lastMemoryQuery = now;
                }
                // Query "Active preset"
                if (now - connectedDevs[i].lastPresetQuery > 2000) {
                    if (connectedDevs[i].ModelID > 21) { // qPreset query not supported from Hero 5 Black
                        bufferBtAction(sendQueryToSingle, [qPreset, i]);
                    } else {
                        // TODO other way to get preset from GoPro Hero 5 Black?
                    }
                    connectedDevs[i].lastPresetQuery = now;
                }
                // Read "Battery level"
                if (now - connectedDevs[i].lastBatteryRead > 10000) {
                    bufferBtAction(readValue, [connectedDevs[i].battLevelCharacteristic]);
                    connectedDevs[i].lastBatteryRead = now;
                }
            }
    }

    function handleRespNotifications(event) {
        let value = event.target.value;
        let uuid = event.target.uuid;
        let sender_id = event.target.service.device.id;
        let bytes = [];

        for (let i = 0; i < value.byteLength; i++) {
            bytes.push(value.getUint8(i));
        }

        var headerLength = getHeaderLength(bytes);
        var command = bytes[headerLength];
        var error = bytes[headerLength + 1];
        for (var i = 0; i < connectedDevs.length; i++) {
            if (connectedDevs[i].server.device.id == sender_id) {
                switch (uuid) {
                    case commandRespUUID:
                        var error_str = "";
                        switch (error) {
                            case 0:
                                error_str = "Success";
                                break;
                            case 1:
                                error_str = "Error";
                                break;
                            case 2:
                                error_str = "Inv. Param.";
                                break;
                            default:
                                error_str = "Unknown";
                        }
                        connectedDevs[i].LE = error_str;
                        break;
                    case settingsRespUUID:
                        if (resp[3] == 0x5B) { // Keep alive
                            // do nothing with keep alive response
                        }
                        break;
                    case queryRespUUID:
                        var resp = new Uint8Array(value.buffer);
                        if (resp[3] == 0x36 && resp[4] == 8) { // Remaining space
                            let bytes = [resp[5], resp[6], resp[7], resp[8], resp[9], resp[10], resp[11], resp[12]];
                            let uint8bytes = Uint8Array.from(bytes);
                            let dataview = new DataView(uint8bytes.buffer);
                            let int64be = dataview.getBigUint64(0);

                            connectedDevs[i].Memory = parseFloat(parseFloat(int64be / 1024n) / 1024.00).toFixed(2) + " GB";
                        } else if (resp[3] == 0x61 && resp[4] == 4) { // Active preset
                            let bytes = [resp[5], resp[6], resp[7], resp[8]];
                            let uint8bytes = Uint8Array.from(bytes);
                            let dataview = new DataView(uint8bytes.buffer);
                            let int32be = dataview.getUint32(0);

                            if (presets[int32be] != null)
                                connectedDevs[i].Preset = presets[int32be];
                            else
                                connectedDevs[i].Preset = "unknown";
                        }
                        break;
                }
            }
        }

        updateList();
    }

    function onDisconnected(event) {
        let sender_id = event.target.id;

        for (var i = 0; i < connectedDevs.length; i++) {
            if (connectedDevs[i].server.device.id == sender_id) {
                showInfo("Cam '" + connectedDevs[i].server.device.name + "' disconnected.", 5000);
                connectedDevs[i].server.device.removeEventListener('gattserverdisconnected', onDisconnected);
                connectedDevs.splice(i, 1);
                updateList();
                break;
            }
        }
        // Close menu
        toggleCamMenu();
    }

    /*
    *   Helpers
    */
    function showInfo(text, millis) {
        document.getElementById("status").innerText = text;
        if (millis > 0)
            window.setTimeout(function () {
                document.getElementById("status").innerText = "";
            }, millis);
    }

    function logError(msg) {
        var errTabBody = document.getElementById("error_log_table").tBodies[0];
        var newRow = errTabBody.insertRow();
        newRow.innerHTML = '<td class="cam-td" style="text-align: center;">' + new Date().toLocaleString() + '</td><td style="text-align: left;padding-left: 10px;">' + msg + '</td>';
    }

    function updateList() {
        var tBody = "";
        for (var i = 0; i < connectedDevs.length; i++) {
            tBody += '<tr><td class="cam-td"><div><span><b>Name: </b>' + connectedDevs[i].Name + '</span> <span><b>Model: </b>' + connectedDevs[i].Model + '</span></div><div><span><b>Preset: </b>' + connectedDevs[i].Preset + '</span></div><div><span><b>Battery: </b>' + connectedDevs[i].Battery + '%</span> <span><b>Memory: </b>' + connectedDevs[i].Memory + '</span></div></td><td><input type="button" class="list-btn" value="&#9776;" onclick="toggleCamMenu(this,  ' + i + ');"></td></tr>';
        };
        dev_list_body.innerHTML = tBody;
    }

    function toggleCamMenu(btn, camIndex) {
        var menuBox = document.getElementById('menu-box');
        if (menuBox.style.display == "block" || btn == null) { // if is menuBox displayed, hide it
            menuBox.style.display = "none";
            menuBox.dataset.camindex = -1;
        } else { // if is menuBox hidden, display it
            menuBox.style.display = "block";
            menuBox.dataset.camindex = camIndex;

            // get the rect of button
            var btnRect = btn.getBoundingClientRect();
            var menuBoxRect = menuBox.getBoundingClientRect();
            // Set the position for menu
            menuBox.style.top = (btnRect.top + 10) + "px";
            menuBox.style.left = (btnRect.right - menuBoxRect.width) + "px";
        }
    }

    function delay(millis) {
        var s = new Date();
        while (new Date() - s < millis);
    }

    function getHeaderLength(command) {
        var headerLength = 0; // 11: Reserved (no msg)
        if (getBit(command[0], 6) == 1 && getBit(command[0], 5) == 0)
            headerLength = 3; // 10: Extended (16-bit)
        else if (getBit(command[0], 6) == 0 && getBit(command[0], 5) == 1)
            headerLength = 2; // 01: Extended (13-bit)
        else if (getBit(command[0], 6) == 0 && getBit(command[0], 5) == 0)
            headerLength = 1; // 00: General

        return headerLength;
    }

    function getBit(num, bit) {
        return ((num >> bit) % 2 != 0 ? 1 : 0)
    }
</script>

</html>
