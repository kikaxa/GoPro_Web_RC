<!DOCTYPE HTML>
<html>

<head>
    <title>GoPro BLE RC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* #1c1c1c dark gray; #4d4d4d gray; #005eab blue; #009fe0 light blue; #fff wihte */
        html {
            font-family: Segoe UI, Frutiger, Frutiger Linotype, Dejavu Sans, Helvetica Neue, Arial, sans-serif;
            display: inline-block;
            text-align: center;
            background-color: #1c1c1c;
            color: #fff;
        }

        input {
            background-color: #009fe0;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-weight: bold;
        }

        input:hover {
            background-color: #005eab;
        }

        legend {
            margin: 0;
        }

        fieldset {
            display: flex;
            border-radius: 5px;
            justify-content: space-around;
            margin: 0 0 10px 0;
        }

        .h2 {
            font-size: 3.0rem;
        }

        p {
            font-size: 1.0rem;
        }

        body {
            max-width: 600px;
            margin: 0px auto;
        }

        fieldset.foldable {
            height: 0px;
            overflow: hidden;
        }

        fieldset.foldable.expanded {
            height: auto;
        }

        fieldset.foldable>legend::after {
            content: "+";
            margin: 0px 5px 0px 15px;
            padding: 0px 8px 5px 8px;
            background-color: #009fe0;
            border-radius: 5px;
            cursor: default;
        }

        fieldset.foldable.expanded>legend::after {
            content: "-";
            margin: 0px 5px 0px 15px;
            padding: 0px 8px 5px 8px;
            background-color: #009fe0;
            border-radius: 5px;
            cursor: default;
        }

        .styled-table {
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9em;
            min-width: 569px;
        }

        .styled-table td {
            padding: 5px 0;
        }

        .styled-table thead tr {
            background-color: #005eab;
            color: #ffffff;
        }

        .styled-table tbody tr {
            border-bottom: 1px solid #dddddd;
            background-color: #4d4d4d;
        }

        .styled-table tbody tr:nth-of-type(even) {
            background-color: #1c1c1c;
        }

        .styled-table tbody tr:last-of-type {
            border-bottom: 2px solid #005eab;
        }
    </style>
</head>

<body> <b class="h2">GoPro RC</b><input type="button" onclick="onClickPair();" value="Connect/Pair new"
        style="margin: 0px 0px 0px 52px;top: 15px;position: fixed;">
    <span id="status" style="display: block;height: 22px;color:#ffbf00;"></span>
    <fieldset>
        <legend><b>Control</b></legend>
        <div style="display:inline-block;"> <input type="button" onclick="sendCommand(shutterOn);" value="Shutter: on">
            <input type="button" onclick="sendCommand(shutterOff);" value="Shutter: off"><br><input type="button"
                onclick="sendCommand(camSleep);" value="Put camera to sleep"> <input type="button"
                onclick="sendCommand(wiFiAPoff);" value="WiFi AP: off"> <input type="button"
                onclick="sendCommand(wiFiAPon);" value="WiFi AP: on"> <input type="button"
                onclick="sendCommand(hilight);" value="Hilight moment">
        </div>
    </fieldset>
    <fieldset class="foldable expanded">
        <legend onclick="this.parentNode.classList.toggle('expanded');"><b>Load Presets</b></legend>
        <div style="display:inline-block;"> <input type="button" onclick="sendCommand(videoGroup);" value="Video Group">
            <input type="button" onclick="sendCommand(photoGroup);" value="Photo Group"> <input type="button"
                onclick="sendCommand(timelapseGroup);" value="Timelapse Group"><br><input type="button"
                onclick="sendCommand(standard);" value="Standard"> <input type="button" onclick="sendCommand(activity);"
                value="Activity"> <input type="button" onclick="sendCommand(cinematic);" value="Cinematic"> <input
                type="button" onclick="sendCommand(photo);" value="Photo"> <input type="button"
                onclick="sendCommand(liveBurst);" value="Live Burst"> <input type="button"
                onclick="sendCommand(burstPhoto);" value="Burst Photo"> <input type="button"
                onclick="sendCommand(nightPhoto);" value="Night Photo"> <input type="button"
                onclick="sendCommand(timeWarp);" value="Time Warp"> <input type="button"
                onclick="sendCommand(timeLapse);" value="Time Lapse"> <input type="button"
                onclick="sendCommand(nightLapse);" value="Night Lapse">
        </div>
    </fieldset>
    <fieldset class="foldable expanded">
        <legend onclick="this.parentNode.classList.toggle('expanded');"><b>Connected devices</b></legend>
        <table id="dev_list" class="styled-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Name</th>
                    <th>Model</th>
                    <th>Mode</th>
                    <th>Battery</th>
                    <th>RSSI</th>
                    <th title="Last Command">LC</th>
                    <th title="Last Error">LE</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </fieldset>

    <script>
        // Custom GoPro services
        var controlServiceUUID = "0000fea6-0000-1000-8000-00805f9b34fb"; // Cam control service
        // Standard services
        var defInfoUUID = "0000180a-0000-1000-8000-00805f9b34fb";  // Device information
        var battInfoUUID = "0000180f-0000-1000-8000-00805f9b34fb"; // Battery service
        // Custom GoPro characteristics
        var commandUUID = "b5f90072-aa8d-11e3-9046-0002a5d5c51b";       // Command [WRITE]
        var commandRespUUID = "b5f90073-aa8d-11e3-9046-0002a5d5c51b";   // Command response [NOTIFY]
        var settingsUUID = "b5f90074-aa8d-11e3-9046-0002a5d5c51b";      // Settings [WRITE]
        var settingsRespUUID = "b5f90075-aa8d-11e3-9046-0002a5d5c51b";  // Settings response [NOTIFY]
        // Standard characteristics
        var modelNoUUID = "00002a24-0000-1000-8000-00805f9b34fb";  // Model number
        var battLevelUUID = "00002a19-0000-1000-8000-00805f9b34fb"; // Battery level [READ | NOTIFY] -> "100% battery level"

        /*
        * Commands
        */
        // The commands below are sent to pSettingsCharacteristic and responses/notifications are received on pSettingsRespCharacteristic
        var keepAlive = Uint8Array.from([0x03, 0x5B, 0x01, 0x42]); // Only Hero 9 and 10 ? Hero 8 response is Error
        // The commands below are sent to pCommandCharacteristic and responses/notifications are received on pCommandRespCharacteristic
        var shutterOff = Uint8Array.from([0x03, 0x01, 0x01, 0x00]);
        var shutterOn = Uint8Array.from([0x03, 0x01, 0x01, 0x01]);
        var camSleep = Uint8Array.from([0x01, 0x05]);
        var wiFiAPoff = Uint8Array.from([0x03, 0x17, 0x01, 0x00]);
        var wiFiAPon = Uint8Array.from([0x03, 0x17, 0x01, 0x01]);
        var hilight = Uint8Array.from([0x01, 0x18]);
        var videoGroup = Uint8Array.from([0x04, 0x3E, 0x02, 0x03, 0xE8]);
        var photoGroup = Uint8Array.from([0x04, 0x3E, 0x02, 0x03, 0xE9]);
        var timelapseGroup = Uint8Array.from([0x04, 0x3E, 0x02, 0x03, 0xEA]);
        var standard = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x00, 0x00, 0x00]);
        var activity = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x00, 0x00, 0x01]);
        var cinematic = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x00, 0x00, 0x02]);
        var photo = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x00]);
        var liveBurst = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x01]);
        var burstPhoto = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x02]);
        var nightPhoto = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x01, 0x00, 0x03]);
        var timeWarp = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x02, 0x00, 0x00]);
        var timeLapse = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x02, 0x00, 0x01]);
        var nightLapse = Uint8Array.from([0x06, 0x40, 0x04, 0x00, 0x02, 0x00, 0x02]);

        var connectedDevs = [];

        var lastListUpdate = 0;
        var dev_list_body = document.getElementById("dev_list").tBodies[0];

        window.addEventListener("DOMContentLoaded", function () {
            showInfo("Please click on 'Connect/Pair new'", 0);

            window.setInterval(function(){
                for (var i = 0; i < connectedDevs.length; i++) {
                    readValue(connectedDevs[i].battLevelCharacteristic);
                };
            }, 5000);
        });

        function onClickPair() {
            let filters = [];
            let options = {};

            filters.push({ services: [controlServiceUUID] });
            options.filters = filters;
            options.optionalServices = [controlServiceUUID, defInfoUUID, battInfoUUID];

            console.log('Requesting Bluetooth Device...');
            console.log('with ' + JSON.stringify(options));

            navigator.bluetooth.requestDevice(options)
                .then(device => {
                    console.log("Connecting to Cam '" + device.name + "'.");

                    showInfo("Connecting to Cam '" + device.name + "'. Please wait...", 0);

                    // Check if device is always conencted
                    for (var i = 0; i < connectedDevs.length; i++) {
                        if (connectedDevs[i].server.device.id == device.id && connectedDevs[i].server.connected) {
                            showInfo("The choosen Cam '" + device.name + "' is always connected!", 3000);
                            return; // device is always connected
                        }
                    }

                    return device.gatt.connect();
                })
                .then(server => {
                    if (server == null) return;

                    console.log('GATT connected');

                    var goProDevice = {};
                    goProDevice.server = server;
                    goProDevice.Name = server.device.name;
                    goProDevice.Model = "?";
                    goProDevice.Mode = "?"; // TODO
                    goProDevice.Battery = "?";
                    goProDevice.RSSI = "?"; // TODO
                    goProDevice.LC = "0";
                    goProDevice.LE = "None";
                    goProDevice.server.device.addEventListener('gattserverdisconnected', onDisconnected);

                    // Save connected Cam in array
                    connectedDevs.push(goProDevice);

                    console.log('Getting Services...');
                    return server.getPrimaryServices();
                })
                .then(service => {
                    if (service == null) return;

                    var n = service.length;
                    for (var i = 0; i < n; i++) {
                        switch (service[i].uuid) {
                            case controlServiceUUID:
                                console.log('Got control Service');
                                console.log('Getting control Characteristics...');
                                getCharacteristic(service[i], commandUUID);
                                getCharacteristic(service[i], commandRespUUID);
                                getCharacteristic(service[i], settingsUUID);
                                getCharacteristic(service[i], settingsRespUUID);
                                break;
                            case defInfoUUID:
                                console.log('Got defInfo Service');
                                console.log('Getting model_number_string Characteristic...');
                                getCharacteristic(service[i], modelNoUUID);
                                break;
                            case battInfoUUID:
                                console.log('Got battInfo Service');
                                console.log('Getting battLevel Characteristic...');
                                getCharacteristic(service[i], battLevelUUID);
                                break;
                        }
                    }
                })
                .catch(error => {
                    console.log('ERROR! ' + error);
                    showInfo(error, 0);
                });
        }

        function getCharacteristic(service, uuid) {
            service.getCharacteristic(uuid)
                .then(characteristic => {
                    if (characteristic == null) return;
                    console.log('Got Characteristic');

                    // Save characteristic in connectedDevs[i]
                    for (var i = 0; i < connectedDevs.length; i++) {
                        if (connectedDevs[i].server.device.id == characteristic.service.device.id) {

                            switch (characteristic.uuid) {
                                case commandUUID:
                                    connectedDevs[i].commandCharacteristic = characteristic;
                                    return;
                                case commandRespUUID:
                                    connectedDevs[i].commandRespCharacteristic = characteristic;
                                    // Start Notification
                                    connectedDevs[i].commandRespCharacteristic.startNotifications().then(_ => {
                                        console.log('> Characteristic Notifications started');
                                        connectedDevs[i].commandRespCharacteristic.addEventListener('characteristicvaluechanged',
                                            handleRespNotifications);

                                        showInfo("Cam '" + connectedDevs[i].server.device.name + "' connected!", 3000);
                                    });
                                    return;
                                case settingsUUID:
                                    connectedDevs[i].settingsCharacteristic = characteristic;
                                    return;
                                case settingsRespUUID:
                                    connectedDevs[i].settingsRespCharacteristic = characteristic;

                                    // Start Notification
                                    connectedDevs[i].settingsRespCharacteristic.startNotifications().then(_ => {
                                        console.log('> Characteristic Notifications started');
                                        connectedDevs[i].settingsRespCharacteristic.addEventListener('characteristicvaluechanged',
                                            handleRespNotifications);
                                    });
                                    return;
                                case modelNoUUID:
                                    connectedDevs[i].modelNoCharacteristic = characteristic;
                                    readValue(characteristic);
                                    return;
                                case battLevelUUID:
                                    connectedDevs[i].battLevelCharacteristic = characteristic;
                                    readValue(characteristic);
                                    return;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.log('ERROR! ' + error);
                    showInfo(error, 0);
                });
        }

        function readValue(characteristic) {
            characteristic.readValue()
                .then(value => {
                    for (var i = 0; i < connectedDevs.length; i++) {
                        if (connectedDevs[i].server.device.id == characteristic.service.device.id) {
                            let decoder = new TextDecoder('utf-8');

                            switch (characteristic.uuid) {
                                case modelNoUUID:
                                    let value_str = decoder.decode(value);

                                    connectedDevs[i].ModelID = parseInt(value_str);

                                    // TODO get all model IDs of working Cams
                                    if (connectedDevs[i].ModelID == 32)
                                        connectedDevs[i].Model = "Hero 8 Black";
                                    else {
                                        connectedDevs[i].Model = value_str;
                                        alert("Please tell the autor your camera model and the ID: " + connectedDevs[i].ModelID);
                                    }


                                    console.log('> Model is ' + connectedDevs[i].Model);

                                    updateList();
                                    return;

                                case battLevelUUID:
                                    connectedDevs[i].Battery = value.getUint8(0);
                                    console.log('> Battery Level is ' + connectedDevs[i].Battery + '%');

                                    updateList();
                                    return;
                            }
                        }
                    }

                })
                .catch(error => {
                    console.log('ERROR! ' + error);
                    showInfo(error, 0);
                });
        }

        function sendCommand(command) {
            var headerLength = getHeaderLength(command);

            for (var i = 0; i < connectedDevs.length; i++) {
                if (connectedDevs[i].server.connected) {
                    connectedDevs[i].commandCharacteristic.writeValue(command);

                    connectedDevs[i].LC = command[headerLength];
                }
            }
        }

        function getHeaderLength(command) {
            var headerLength = 0; // 11: Reserved (no msg)
            if (getBit(command[0], 6) == 1 && getBit(command[0], 5) == 0)
                headerLength = 3; // 10: Extended (16-bit)
            else if (getBit(command[0], 6) == 0 && getBit(command[0], 5) == 1)
                headerLength = 2; // 01: Extended (13-bit)
            else if (getBit(command[0], 6) == 0 && getBit(command[0], 5) == 0)
                headerLength = 1; // 00: General

            return headerLength;
        }

        function getBit(num, bit) {
            return ((num >> bit) % 2 != 0 ? 1 : 0)
        }

        function handleRespNotifications(event) {
            let value = event.target.value;
            let sender_id = event.target.service.device.id;
            let bytes = [];

            for (let i = 0; i < value.byteLength; i++) {
                bytes.push(value.getUint8(i));
            }

            var headerLength = getHeaderLength(bytes);
            var command = bytes[headerLength];
            var error = bytes[headerLength + 1];

            for (var i = 0; i < connectedDevs.length; i++) {
                if (connectedDevs[i].server.device.id == sender_id && connectedDevs[i].LC == command) {
                    var error_str = "";

                    switch (error) {
                        case 0:
                            error_str = "Success";
                            break;
                        case 1:
                            error_str = "Error";
                            break;
                        case 2:
                            error_str = "Invalid Parameter";
                            break;
                        default:
                            error_str = "Unknown";
                    }
                    connectedDevs[i].LE = error_str;

                    updateList();
                    return;
                }
            }
        }

        function showInfo(text, millis) {
            document.getElementById("status").innerText = text;

            if (millis > 0)
                window.setTimeout(function () {
                    document.getElementById("status").innerText = "";
                }, millis);
        }

        function updateList() {
            var tBody = "";
            for (var i = 0; i < connectedDevs.length; i++) {
                tBody += '<tr><td>' + (i + 1) + '</td><td>' + connectedDevs[i].Name + "</td><td>" + connectedDevs[i].Model + "</td><td>" + connectedDevs[i].Mode + "</td><td>" + connectedDevs[i].Battery + "%</td><td>" + connectedDevs[i].RSSI + "</td><td>" + connectedDevs[i].LC + "</td><td>" + connectedDevs[i].LE + "</td></tr>\n";
            };
            dev_list_body.innerHTML = tBody;
        }

        function onDisconnected(event) {
            let sender_id = event.target.id;

            for (var i = 0; i < connectedDevs.length; i++) {
                if (connectedDevs[i].server.device.id == sender_id) {
                    showInfo("Cam '" + connectedDevs[i].server.device.name + "' disconnected.", 5000);

                    connectedDevs.splice(i, 1);

                    updateList();
                    return;
                }
            }
        }
    </script>
</body>

</html>